trigger:
- main

variables:
  system.debug: 'true'

pool:
  vmImage: ubuntu-latest

jobs:
- job: LaravelCI
  displayName: "Laravel CI Pipeline"
  steps:

    # Include pre-steps template (MUST be a steps-template)
    - template: system-pre-steps.yml

    - checkout: self
      fetchDepth: 1
      displayName: "Checkout Code"

    # Install PHP + common Laravel extensions
    - script: |
        set -e
        sudo apt-get update
        sudo apt-get install -y \
          php php-cli php-mbstring php-xml php-curl php-zip php-bcmath php-intl php-gd \
          php-mysql php-sqlite3 unzip git curl

        php -v
        php -m | sort
      displayName: "Install PHP + Extensions"

    # Install Composer (official method)
    - script: |
        set -e
        php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
        php composer-setup.php --install-dir=/usr/local/bin --filename=composer
        rm -f composer-setup.php
        composer --version
      displayName: "Install Composer"

    # Cache Composer downloads (optional but helpful)
    - task: Cache@2
      inputs:
        key: 'composer | "$(Agent.OS)" | composer.lock'
        restoreKeys: |
          composer | "$(Agent.OS)"
        path: $(Pipeline.Workspace)/.composer
      displayName: "Cache Composer"
    - script: |
        echo "##vso[task.setvariable variable=COMPOSER_CACHE_DIR]$(Pipeline.Workspace)/.composer"
      displayName: "Set Composer cache dir"

    - script: |
        set -e
        composer install --no-interaction --prefer-dist --no-progress
      displayName: "Composer Install"

    # Laravel app setup for CI testing
    - script: |
        set -e

        # Create .env
        if [ -f .env.example ]; then
          cp .env.example .env
        else
          echo ".env.example not found!"
          exit 1
        fi

        # Generate key
        php artisan key:generate --force

        # Use sqlite in-memory for tests (most portable for CI)
        {
          echo
