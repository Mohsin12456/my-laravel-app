trigger:
- main

variables:
  system.debug: 'false'
  # This is the variable your template is checking (was Null in your log)
  system.debugContext: 'false'

pool:
  vmImage: 'SelfHosted'

jobs:
- job: LaravelCI
  displayName: "Laravel CI Pipeline"
  steps:

    # Pre-steps template (steps template)
    - template: system-pre-steps.yml
      parameters:
        debugContext: 'true'

    - checkout: self
      fetchDepth: 1
      displayName: "Checkout Code"

    - script: |
        set -e
        sudo apt-get update
        sudo apt-get install -y \
          php php-cli php-mbstring php-xml php-curl php-zip php-bcmath php-intl php-gd \
          php-mysql php-sqlite3 unzip git curl

        php -v
      displayName: "Install PHP + Extensions"

    - script: |
        set -e
        php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
        php composer-setup.php --install-dir=/usr/local/bin --filename=composer
        rm -f composer-setup.php
        composer --version
      displayName: "Install Composer"

    - script: |
        set -e
        composer install --no-interaction --prefer-dist --no-progress
      displayName: "Composer Install"

    - script: |
        set -e
        cp .env.example .env
        php artisan key:generate --force

        # DB for CI (portable)
        {
          echo ""
          echo "APP_ENV=testing"
          echo "APP_DEBUG=true"
          echo "DB_CONNECTION=sqlite"
          echo "DB_DATABASE=:memory:"
          echo "CACHE_DRIVER=array"
          echo "SESSION_DRIVER=array"
          echo "QUEUE_CONNECTION=sync"
        } >> .env

        php artisan config:clear
      displayName: "Laravel Setup (testing env)"

    - script: |
        set -e
        php artisan test --no-interaction
      displayName: "Run Laravel Tests"

    - script: echo "âœ… Laravel CI Pipeline Completed Successfully"
      displayName: "Pipeline Success"
