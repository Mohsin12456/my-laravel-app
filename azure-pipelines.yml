trigger:
- main

variables:
  system.debug: 'false'
  system.debugContext: 'false'

pool:
  name: 'Default'

jobs:
- job: LaravelCI
  displayName: "Laravel CI Pipeline"
  steps:

    - checkout: self
      fetchDepth: 1
      displayName: "Checkout Code"

    - powershell: |
        # Install Chocolatey if missing
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

        if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
          Write-Host "Installing Chocolatey..."
          iex ((New-Object Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        }

        choco --version
      displayName: "Ensure Chocolatey"

    - powershell: |
        # Install PHP
        choco install php -y
        refreshenv

        php -v
        php -m
      displayName: "Install PHP + Extensions (Windows)"

    - powershell: |
        # Install Composer
        php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
        php composer-setup.php --install-dir="C:\Windows\System32" --filename=composer
        Remove-Item -Force composer-setup.php

        composer --version
      displayName: "Install Composer (Windows)"

    - powershell: |
        composer install --no-interaction --prefer-dist --no-progress
      displayName: "Composer Install"

    - powershell: |
        Copy-Item .env.example .env -Force
        php artisan key:generate --force

        Add-Content .env "`nAPP_ENV=testing"
        Add-Content .env "APP_DEBUG=true"
        Add-Content .env "DB_CONNECTION=sqlite"
        Add-Content .env "DB_DATABASE=:memory:"
        Add-Content .env "CACHE_DRIVER=array"
        Add-Content .env "SESSION_DRIVER=array"
        Add-Content .env "QUEUE_CONNECTION=sync"

        php artisan config:clear
      displayName: "Laravel Setup (testing env)"

    - powershell: |
        php artisan test --no-interaction
      displayName: "Run Laravel Tests"

    - powershell: |
        Write-Host "âœ… Laravel CI Pipeline Completed Successfully"
      displayName: "Pipeline Success"
