trigger:
- main

variables:
  system.debug: 'false'
  LARAVEL_DIR: '$(Build.SourcesDirectory)'   # change to '$(Build.SourcesDirectory)\backend' if needed
  PHP_EXE: 'C:\php\php.exe'

pool:
  name: 'Default'

jobs:
- job: LaravelCI
  displayName: "Laravel CI Pipeline (Self-hosted Windows)"
  steps:

  - checkout: self
    fetchDepth: 1
    displayName: "Checkout Code"

  - powershell: |
      $ErrorActionPreference = "Stop"

      Write-Host "Build.SourcesDirectory: $(Build.SourcesDirectory)"
      Write-Host "Laravel dir: $(LARAVEL_DIR)"
      dir "$(Build.SourcesDirectory)"
      if (Test-Path "$(LARAVEL_DIR)") { dir "$(LARAVEL_DIR)" } else { throw "LARAVEL_DIR not found: $(LARAVEL_DIR)" }
    displayName: "Debug: show repo structure"

  - powershell: |
      $ErrorActionPreference = "Stop"

      $php = "$(PHP_EXE)"
      if (!(Test-Path $php)) { throw "PHP not found at $php" }

      # Make php available in PATH for later steps (optional)
      Write-Host "##vso[task.prependpath]C:\php"

      Write-Host "PHP version:"
      & $php -v

      Write-Host "PHP modules:"
      & $php -m
    displayName: "Verify PHP (Windows)"

  - powershell: |
      $ErrorActionPreference = "Stop"

      Write-Host "Git version:"
      git --version

      Write-Host "Git location:"
      where.exe git
    displayName: "Verify Git (Windows)"

  # --- Skip composer/test steps if this repo doesn't contain a Laravel project ---
  - powershell: |
      $ErrorActionPreference = "Stop"

      $laravelDir = "$(LARAVEL_DIR)"
      $composerJson = Join-Path $laravelDir "composer.json"
      $artisan = Join-Path $laravelDir "artisan"

      if (!(Test-Path $composerJson)) {
        Write-Host "##vso[task.logissue type=warning]composer.json not found at: $composerJson"
        Write-Host "This repo does not look like a Laravel app repo (or LARAVEL_DIR is wrong). Skipping Composer + Laravel tests."
        Write-Host "##vso[task.setvariable variable=SKIP_LARAVEL]true"
        exit 0
      }

      if (!(Test-Path $artisan)) {
        Write-Host "##vso[task.logissue type=warning]artisan not found at: $artisan"
        Write-Host "Skipping Laravel steps."
        Write-Host "##vso[task.setvariable variable=SKIP_LARAVEL]true"
        exit 0
      }

      Write-Host "Laravel project detected. Continuing..."
      Write-Host "##vso[task.setvariable variable=SKIP_LARAVEL]false"
    displayName: "Detect Laravel project (set SKIP_LARAVEL)"

  - powershell: |
      $ErrorActionPreference = "Stop"
      $php = "$(PHP_EXE)"

      cd "$(LARAVEL_DIR)"

      Write-Host "Downloading composer.phar..."
      & $php -r "copy('https://getcomposer.org/composer-stable.phar', 'composer.phar');"

      Write-Host "Composer version:"
      & $php .\composer.phar --version
    displayName: "Install Composer (local)"
    condition: and(succeeded(), ne(variables['SKIP_LARAVEL'], 'true'))

  - powershell: |
      $ErrorActionPreference = "Stop"
      $php = "$(PHP_EXE)"
      $env:COMPOSER_MEMORY_LIMIT = "-1"

      cd "$(LARAVEL_DIR)"

      Write-Host "Composer diagnose:"
      & $php .\composer.phar diagnose

      Write-Host "Running composer install..."
      & $php .\composer.phar install `
        --no-interaction `
        --prefer-dist `
        --no-progress `
        --ignore-platform-reqs
    displayName: "Composer Install"
    condition: and(succeeded(), ne(variables['SKIP_LARAVEL'], 'true'))

  - powershell: |
      $ErrorActionPreference = "Stop"
      $php = "$(PHP_EXE)"

      cd "$(LARAVEL_DIR)"

      if (!(Test-Path ".env.example")) {
        throw ".env.example not found in $(LARAVEL_DIR). If your app uses a different env template, update this step."
      }

      Copy-Item .env.example .env -Force
      & $php artisan key:generate --force

      Add-Content .env "`nAPP_ENV=testing"
      Add-Content .env "APP_DEBUG=true"
      Add-Content .env "DB_CONNECTION=sqlite"
      Add-Content .env "DB_DATABASE=:memory:"
      Add-Content .env "CACHE_DRIVER=array"
      Add-Content .env "SESSION_DRIVER=array"
      Add-Content .env "QUEUE_CONNECTION=sync"

      & $php artisan config:clear
    displayName: "Laravel Setup (testing env)"
    condition: and(succeeded(), ne(variables['SKIP_LARAVEL'], 'true'))

  - powershell: |
      $ErrorActionPreference = "Stop"
      $php = "$(PHP_EXE)"

      cd "$(LARAVEL_DIR)"
      & $php artisan test --no-interaction
    displayName: "Run Laravel Tests"
    condition: and(succeeded(), ne(variables['SKIP_LARAVEL'], 'true'))

  - powershell: |
      Write-Host "✅ Pipeline Completed"
      if ("$(SKIP_LARAVEL)" -eq "true") {
        Write-Host "ℹ️ Laravel steps were skipped because composer.json/artisan was not found."
      } else {
        Write-Host "✅ Laravel CI ran successfully."
      }
    displayName: "Pipeline Summary"
