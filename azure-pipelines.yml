trigger:
- main

variables:
  system.debug: 'false'
  system.debugContext: 'false'

pool:
  name: 'Default'

jobs:
- job: LaravelCI
  displayName: "Laravel CI Pipeline (Windows)"
  steps:

    - checkout: self
      fetchDepth: 1
      displayName: "Checkout Code"

    - powershell: |
        $ErrorActionPreference = "Stop"

        $php = "C:\php\php.exe"
        if (!(Test-Path $php)) { throw "PHP not found at $php" }

        # Ensure PHP is available to later steps
        Write-Host "##vso[task.prependpath]C:\php"

        Write-Host "PHP version:"
        & $php -v

        Write-Host "PHP modules:"
        & $php -m
      displayName: "Verify PHP (Windows)"

    - powershell: |
        $ErrorActionPreference = "Stop"

        Write-Host "PATH:"
        Write-Host $env:PATH

        Write-Host "Git version:"
        git --version

        Write-Host "Git location:"
        where.exe git
      displayName: "Verify Git (Windows)"

    - powershell: |
        $ErrorActionPreference = "Stop"
        $php = "C:\php\php.exe"

        Write-Host "Downloading composer.phar..."
        & $php -r "copy('https://getcomposer.org/composer-stable.phar', 'composer.phar');"

        Write-Host "Composer version:"
        & $php .\composer.phar --version
      displayName: "Install Composer (local)"

    - powershell: |
        $ErrorActionPreference = "Stop"
        $php = "C:\php\php.exe"

        # Avoid memory issues on Windows
        $env:COMPOSER_MEMORY_LIMIT = "-1"

        Write-Host "Composer diagnose:"
        & $php .\composer.phar diagnose

        Write-Host "Running composer install..."
        & $php .\composer.phar install `
          --no-interaction `
          --prefer-dist `
          --no-progress `
          --ignore-platform-reqs
      displayName: "Composer Install"

    - powershell: |
        $ErrorActionPreference = "Stop"
        $php = "C:\php\php.exe"

        if (!(Test-Path ".env.example")) {
          throw ".env.example not found in repo root. Make sure pipeline is running in the Laravel project root."
        }

        Copy-Item .env.example .env -Force
        & $php artisan key:generate --force

        Add-Content .env "`nAPP_ENV=testing"
        Add-Content .env "APP_DEBUG=true"
        Add-Content .env "DB_CONNECTION=sqlite"
        Add-Content .env "DB_DATABASE=:memory:"
        Add-Content .env "CACHE_DRIVER=array"
        Add-Content .env "SESSION_DRIVER=array"
        Add-Content .env "QUEUE_CONNECTION=sync"

        & $php artisan config:clear
      displayName: "Laravel Setup (testing env)"

    - powershell: |
        $ErrorActionPreference = "Stop"
        $php = "C:\php\php.exe"

        & $php artisan test --no-interaction
      displayName: "Run Laravel Tests"

    - powershell: |
        Write-Host "âœ… Laravel CI Pipeline Completed Successfully"
      displayName: "Pipeline Success"
